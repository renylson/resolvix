# RESOLVIX - DNS Recursivo de Alta Performance

DNS Recursivo profissional baseado em Unbound com Prometheus para monitoramento.

**Autor:** Renylson Marques  
**Email:** renylsonm@gmail.com  
**Telefone:** (87) 98846-3681

## ‚ú® Caracter√≠sticas

- **Unbound v1.22.0**: DNS recursivo de alta performance
- **DNSSEC**: Valida√ß√£o segura de respostas DNS
- **IPv4 + IPv6**: Suporte completo
- **Prometheus**: Monitoramento e coleta de m√©tricas
- **16 Threads**: Otimizado para milh√µes de requisi√ß√µes por segundo
- **512MB Cache**: Mensagens + RRSET

## üìã Requisitos

- Debian 13+
- Root access
- Conex√£o com internet

## üöÄ Instala√ß√£o

### Modo Interativo (com perguntas)

```bash
cd /root/resolvix
sudo bash install_dns.sh
```

### Modo Autom√°tico (sem perguntas)

```bash
cd /root/resolvix
echo -e "s\n2\n2\n\ns\ns" | sudo bash install_dns.sh
```

**Op√ß√µes padr√£o autom√°ticas:**
- Continuar: `s` (sim)
- Modo IP: `2` (P√∫blico)
- Vers√£o IP: `2` (IPv4 + IPv6)
- Blocos IP: vazio (IPs privados padr√£o)
- Prometheus: `s` (sim)
- Confirma√ß√£o final: `s` (sim)

## üîß Configura√ß√£o P√≥s-Instala√ß√£o

### Verificar Status

```bash
# Unbound
systemctl status unbound

# Exportador Prometheus
systemctl status unbound-exporter

# Prometheus
systemctl status prometheus
```

### Testar DNS

```bash
# Teste simples
dig @127.0.0.1 google.com

# Com nslookup
nslookup google.com 127.0.0.1

# Estat√≠sticas
unbound-control stats
```

### Acessar Interfaces

- **Prometheus UI**: http://seu-ip:9090
- **M√©tricas Unbound**: http://seu-ip:9100/metrics

## üìö Comandos √öteis

### Unbound

```bash
# Reiniciar
systemctl restart unbound

# Parar
systemctl stop unbound

# Logs em tempo real
journalctl -u unbound -f

# Verificar configura√ß√£o
unbound-checkconf

# Recarregar sem reiniciar
unbound-control reload
```

### Prometheus

```bash
# Reiniciar
systemctl restart prometheus

# Parar
systemctl stop prometheus

# Logs
journalctl -u prometheus -f
```

### Exportador

```bash
# Reiniciar
systemctl restart unbound-exporter

# Logs
journalctl -u unbound-exporter -f

# Testar m√©tricas
curl http://127.0.0.1:9100/metrics
```

## üîê Configura√ß√µes de Seguran√ßa

### Modo de Opera√ß√£o

- **Local**: Aceita consultas de qualquer origem (desenvolvimento)
- **P√∫blico**: Restringe a IPs privados (produ√ß√£o)

### IPs Privados Permitidos

- `10.0.0.0/8` (IPv4)
- `172.16.0.0/12` (IPv4)
- `192.168.0.0/16` (IPv4)
- `100.64.0.0/10` (IPv4)
- `::1` (IPv6 loopback)
- `::ffff:0:0/96` (IPv6 mapped IPv4)

### Blocos Customizados (IPv4 e IPv6)

Durante a instala√ß√£o, voc√™ pode adicionar blocos customizados:

**Exemplos:**
```
203.0.113.0/24 203.0.114.0/24 2001:db8::/32
```

Editar `/etc/unbound/unbound.conf` para adicionar/modificar:

```
# IPv4
access-control: 203.0.113.0/24 allow
access-control: 203.0.114.0/24 allow

# IPv6
access-control: 2001:db8::/32 allow
access-control: 2001:db9::/32 allow
```

Depois reiniciar:
```bash
systemctl restart unbound
```

## üìä Monitoramento

### M√©tricas Dispon√≠veis

- Queries totais
- Cache hits/misses
- DNSSEC queries e falhas
- Recursion queries
- Timeouts
- Respostas

### Prometheus Queries

```promql
# Queries por segundo
rate(unbound_thread0_num_queries[5m])

# Cache hit rate
rate(unbound_thread0_num_queries_cache_hit[5m])

# DNSSEC validations
rate(unbound_total_dnssec_queries[5m])
```

## üõ†Ô∏è Troubleshooting

### DNS n√£o responde

```bash
# Verificar se Unbound est√° ativo
systemctl is-active unbound

# Ver logs
journalctl -u unbound --no-pager -n 20

# Testar localmente
dig @127.0.0.1 google.com
```

### Porta 53 j√° em uso

```bash
# Encontrar processo
sudo lsof -i :53

# Se systemd-resolved estiver usando:
sudo systemctl stop systemd-resolved
sudo systemctl mask systemd-resolved
```

### Prometheus n√£o coleta m√©tricas

```bash
# Verificar exportador
curl http://127.0.0.1:9100/health

# Ver m√©tricas
curl http://127.0.0.1:9100/metrics

# Logs do Prometheus
journalctl -u prometheus -f
```

## üìÅ Estrutura de Diret√≥rios

```
/etc/unbound/                  # Configura√ß√£o Unbound
/etc/prometheus/               # Configura√ß√£o Prometheus
/opt/resolvix/                 # Scripts Resolvix
  ‚îú‚îÄ‚îÄ unbound_exporter.py      # Exportador Prometheus
  ‚îî‚îÄ‚îÄ ...
/opt/prometheus/               # Bin√°rios Prometheus
/var/lib/prometheus/           # Dados Prometheus
/var/lib/unbound/              # Cache Unbound
```

## üîÑ Backup e Restore

### Backup

```bash
# Backup Unbound
cp /etc/unbound/unbound.conf /etc/unbound/unbound.conf.backup.$(date +%Y%m%d)

# Backup Prometheus
tar czf prometheus_backup.tar.gz /etc/prometheus /var/lib/prometheus
```

### Restore

```bash
# Restaurar Unbound
cp /etc/unbound/unbound.conf.backup.YYYYMMDD /etc/unbound/unbound.conf
systemctl restart unbound

# Restaurar Prometheus
tar xzf prometheus_backup.tar.gz -C /
systemctl restart prometheus
```

## üìù Logs

- **Unbound**: `journalctl -u unbound`
- **Prometheus**: `journalctl -u prometheus`
- **Exportador**: `journalctl -u unbound-exporter`

## ü§ù Suporte

Para mais informa√ß√µes e documenta√ß√£o oficial:

- [Unbound Documentation](https://unbound.docs.nlnetlabs.nl/)
- [Prometheus Documentation](https://prometheus.io/docs/)
- [Reposit√≥rio RESOLVIX](https://github.com/renylson/resolvix)

## üìÑ Licen√ßa

Este projeto √© fornecido como est√°. Consulte o autor para mais informa√ß√µes.

---

**√öltima atualiza√ß√£o:** 2025-10-29  
**Vers√£o:** 2.1 (IPv4 + IPv6 em blocos customizados)
